---
title: "IPS9 in R: Inference for Categorical Data (Chapter 9)"
author: "Shukry Zablah (szablah20@amherst.edu) and Nicholas Horton (nhorton@amherst.edu)"
date: "July 19, 2018"
output: 
  pdf_document:
    fig_height: 3
    fig_width: 5
  html_document:
    fig_height: 3
    fig_width: 5
  word_document:
    fig_height: 4
    fig_width: 6
---


```{r, include = FALSE}
# Don't delete this chunk if you are using the mosaic package
# This loads the mosaic and dplyr packages
require(mosaic)
```

```{r, include = FALSE}
# knitr settings to control how R chunks work.
knitr::opts_chunk$set(
  tidy = FALSE,     # display code as typed
  size = "small"    # slightly smaller font for code
)
```

## Introduction and background 

These documents are intended to help describe how to undertake analyses introduced 
as examples in the Ninth Edition of \emph{Introduction to the Practice of Statistics} (2017) by Moore, McCabe, and Craig.

More information about the book can be found [here](https://macmillanlearning.com/Catalog/product/introductiontothepracticeofstatistics-ninthedition-moore).
The data used in these documents can be found under Data Sets in the [Student Site](https://www.macmillanlearning.com/catalog/studentresources/ips9e?_ga=2.29224888.526668012.1531487989-1209447309.1529940008#). This
file as well as the associated R Markdown reproducible analysis source file used to create it can be found at https://nhorton.people.amherst.edu/ips9/.

This work leverages initiatives undertaken by Project MOSAIC (http://www.mosaic-web.org), an NSF-funded effort to improve the teaching of statistics, calculus, science and computing in the undergraduate curriculum. In particular, we utilize the `mosaic` package, which was written to simplify the use of R for introductory statistics courses. A short summary of the R needed to teach introductory statistics can be found in the mosaic package vignettes (http://cran.r-project.org/web/packages/mosaic).  A paper describing the mosaic approach was published in the *R Journal*: https://journal.r-project.org/archive/2017/RJ-2017-024.
  
## Chapter 9: Inference for Categorical Data
This file replicates the analyses from Chapter 9: Inference for Categorical Data. 

First, load the packages that will be needed for this document: 
```{r load-packages}
library(mosaic)
library(readr)
```

### Section 9.1: Inference for two-way tables

We will first recreate the dataset based on the table of counts that is provided in Example 9.1 in page 526. 

```{r}
Instag <- rbind(
  do(298) * data.frame(Sex = "Men",  User = "No"),
  do(209) * data.frame(Sex = "Women", User = "No"),
  do(234) * data.frame(Sex = "Men",  User = "Yes"), 
  do(328) * data.frame(Sex = "Women", User = "Yes")
)  
head(Instag)
```

In the code chunk above we are adding the appropriate number of observations (based on the counts) with their respective attributes (whether they are men or women and a user or not) into the dataset. We take a small peek of the dataset with the `head()` function that returns the first few observations from a given dataset. 

To recreate the table in Example 9.1 we first get the total count per sex. 

```{r}
Combined_Sex <- Instag %>% 
  group_by(Sex) %>%
  summarize(n = n()) 
Combined_Sex
```

Then we get a dataframe with only the counts of those who have a value of "Yes" for User. 

```{r}
YesUsers <- Instag %>% 
  group_by(User, Sex) %>%
  summarize(n = n()) %>%
  filter(User == "Yes")
YesUsers
```

And finally, we combine them and create the $$\hat{p} = X/n$$ column. 

```{r}
Ex8.11Table <- Combined_Sex %>%
  left_join(YesUsers, by = "Sex") %>%
  select(Sex, n = n.x, X = n.y) %>%
  mutate(`p_hat = X/n` = X/n) 
Ex8.11Table
```

And we then have the table with the percentages of yes over number of users!

Now take look at Example 9.2 in page 526. To recreate that table of counts we simply have to call the `tally()` function and it will make the 2-way table for us. 

We call it like this: 

```{r}
tally(~ User + Sex, data = Instag, margins = TRUE)  
```

The `margins = TRUE` optio makes sure that `tally()` ouputs the convenient Total columns just like in page 527!

Turn your attention to Example 9.3 now. After creating the dataset from the counts, we can use a similar call to recreate the table and verify that our dataset is in fact accurate. 

```{r}
Vaccine <- rbind(
  do(729) * data.frame(Required = "Yes", Party = "Democratic"),
  do(479) * data.frame(Required = "Yes", Party = "Republican"),
  do(230) * data.frame(Required = "No",  Party = "Democratic"), 
  do(258) * data.frame(Required = "No", Party = "Republican")
)  

tally(~ Required + Party, data = Vaccine, margins = TRUE)
```

Now we continue to explore our 2 way tables. In Example 9.5 we can see the marginal distribution of our Vaccine tables across political party preference. We recreate it with a call to `tally()`. 

```{r}
tally(Required ~ Party, data = Vaccine, margins = TRUE, format = "percent")
```

```{r}
gf_percents(~ Required, data = Vaccine, fill = ~ Party, position = "dodge")
```

Note that this is not an equivalent bar graph but still provides the same useful information. 

```{r}
vcd::mosaic(~ Required | Party, data = Vaccine, format = "percent")
```

In Example 9.7 we are interested in getting the expected counts of our Vaccine data. In R you can take advantage of the `chisq.test()` function and get the relevant output like this: 

```{r}
chiSqVaccine <- chisq.test(tally(Required ~ Party, data = Vaccine), correct = FALSE)
with(chiSqVaccine, expected)
```

We specify the `correct = FALSE` option to match the book's table. This option specifies that there should be no continuity correction applied to our test. You can see how the output changes by removing that option. 

Similarly we could get the observed counts we calculated with `tally()` before. We just need to use the same test and get the relevant part of the returned object. 

```{r}
with(chiSqVaccine, observed)
```

To see the output of the Chi-Square test discussed in Example 9.8. Note that the book has a mistake. While it showed the correct output, it specified the wrong $$\chi^2$$ squared value. 

```{r}
chiSqVaccine
```

```{r}
Health <- rbind(
  do(69) *  data.frame(PhysAct = "Low", FruitConsumption = "Low"),
  do(206) * data.frame(PhysAct = "Moderate", FruitConsumption = "Low"),
  do(294) * data.frame(PhysAct = "Vigorous",  FruitConsumption = "Low"), 
  do(25) *  data.frame(PhysAct = "Low", FruitConsumption = "Medium"),
  do(126) * data.frame(PhysAct = "Moderate", FruitConsumption = "Medium"),
  do(170) * data.frame(PhysAct = "Vigorous", FruitConsumption = "Medium"),
  do(14) *  data.frame(PhysAct = "Low",  FruitConsumption = "High"), 
  do(111) * data.frame(PhysAct = "Moderate", FruitConsumption = "High"),
  do(169) * data.frame(PhysAct = "Vigorous", FruitConsumption = "High")
)  
```


```{r}
tally(~ PhysAct + FruitConsumption, data = Health, margins = TRUE)
```

```{r}
tally(FruitConsumption ~ PhysAct, data = Health, margins = TRUE, format = "percent")
```

```{r}
gf_percents(~ FruitConsumption | PhysAct, data = Health)
```

Note that these are not equivalent bar graphs to the one in the book (XX FIGURE NUMBER) but they still provide the same useful information. 

```{r}
chiSqHealth <- chisq.test(tally(FruitConsumption ~ PhysAct, data = Health), correct = FALSE)
with(chiSqHealth, expected)
```

```{r}
with(chiSqHealth, observed)
```

```{r}
chiSqHealth
```

### Section 9.2: Goodness of fit

```{r}
ACT <- rbind(
  do(167) * data.frame(State = "AZ", label = 1),
  do(257) * data.frame(State = "CA", label = 2),
  do(257) * data.frame(State = "HI", label = 3),
  do(297) * data.frame(State = "IN", label = 4),
  do(107) * data.frame(State = "NV", label = 5),
  do(482) * data.frame(State = "OH", label = 6)
)
```

```{r}
tally(~ State, data = ACT, margins = TRUE)
```

```{r}
tally(~ State, data = ACT, margins = TRUE, format = "prop")

```